<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediCare AI Specialist</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #008080; --primary-light: #e0f2f1; --bg: #f4f6f8; --text-dark: #2d3436; }
        b, strong { color: #000; font-weight: 800; }
        body { background: var(--bg); color: var(--text-dark); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        .sidebar { width: 380px; background: #fff; border-right: 1px solid #ddd; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; box-shadow: 2px 0 15px rgba(0,0,0,0.05); }
        .brand { font-family: 'Poppins', sans-serif; color: var(--primary); font-size: 1.4rem; display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        
        label { font-size: 0.75rem; font-weight: 700; color: #555; margin-bottom: 2px; display: block; }
        .input-group { position: relative; }
        .input-group i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--primary); font-size:0.8rem; }
        input, select, textarea { width: 100%; padding: 8px 8px 8px 30px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        textarea { padding-left: 8px; resize: vertical; min-height: 50px; }
        input:focus { border-color: var(--primary); outline: none; }

        .upload-box { border: 2px dashed #ccc; padding: 15px; text-align: center; cursor: pointer; border-radius: 8px; background: #fafafa; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; min-height: 100px; }
        .upload-box:hover { border-color: var(--primary); background: var(--primary-light); }
        #preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; display: none; }
        
        .btn { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; margin-top: 5px; display: flex; justify-content: center; gap: 5px; }
        .btn:hover { background: #006666; transform: translateY(-1px); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); width: auto; padding: 6px 12px; font-size: 0.85rem; }
        .btn-outline:hover { background: var(--primary-light); }

        /* Chat */
        .main { flex: 1; display: flex; flex-direction: column; background: #f0f2f5; position: relative; }
        .chat-header { background: #fff; padding: 15px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #chat-box { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 15px; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .ai-msg { background: #fff; }
        .user-msg { background: var(--primary); color: white; align-self: flex-end; }
        .chat-input { padding: 20px; background: #fff; display: flex; gap: 10px; }
        #userMsg { padding-left: 10px; }

        /* Report Results */
        #results-card { background: #fff; padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-top: 15px; display: none; }
        .progress-track { background: #eee; height: 6px; border-radius: 3px; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 1s; }
        .progress-fill.high { background: #e74c3c; }

        /* Modals */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 999; }
        .paper { background: white; width: 400px; padding: 30px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; }
        .report-paper { width: 700px; padding: 40px; text-align: left; max-height: 90vh; overflow-y: auto; }

        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; font-size: 0.9rem; }
        .section-title { background: #eee; padding: 5px 10px; font-weight: bold; margin: 15px 0 5px 0; border-left: 4px solid var(--primary); }
        .disclaimer { font-size: 0.7rem; color: #c0392b; border: 1px solid #e74c3c; background: #fdf2f2; padding: 10px; margin-top: 20px; text-align: center; border-radius: 4px; }

        @media print {
            body * { visibility: hidden; }
            .overlay, .overlay * { visibility: visible; }
            .overlay { background: white; position: absolute; top: 0; left: 0; display: block !important; }
            .report-paper { box-shadow: none; width: 100%; padding: 0; }
            .btn { display: none; }
        }
    </style>
</head>
<body>

<div class="overlay" id="loginModal">
    <div class="paper">
        <h2 style="color:var(--primary); margin-top:0;">Doctor Login</h2>
        <p style="color:#666; margin-bottom:20px;">Secure Access for Medical Staff</p>
        
        <div class="input-group" style="margin-bottom:10px;">
            <i class="fa-solid fa-user-md"></i>
            <input type="text" id="l_user" placeholder="Username" value="doctor"> 
        </div>
        <div class="input-group" style="margin-bottom:20px;">
            <i class="fa-solid fa-key"></i>
            <input type="password" id="l_pass" placeholder="Password" value="admin123"> 
        </div>

        <button class="btn" onclick="performLogin()">Login</button>
        
        <div style="margin-top:20px; padding:10px; background:#e0f2f1; border:1px dashed #008080; border-radius:5px; font-size:0.8rem; color:#333;">
            <strong>Demo Credentials:</strong><br>
            User: <b>doctor</b> | Pass: <b>admin123</b>
        </div>

        <p style="font-size:0.8rem; margin-top:15px; cursor:pointer; color:gray; text-decoration:underline;" onclick="document.getElementById('loginModal').style.display='none'">Continue as Patient (Guest)</p>
    </div>
</div>

<div class="sidebar">
    <div class="brand"><i class="fa-solid fa-user-doctor"></i> MediCare AI</div>
    
    <label>Select Scan</label>
    <div class="input-group"><i class="fa-solid fa-layer-group"></i>
        <select id="scan_type"><option value="xray">Chest X-Ray</option><option value="mri">Brain MRI</option><option value="skin">Skin Lesion</option><option value="ct">Chest CT</option></select>
    </div>

    <label>Patient Name <span style="color:red">*</span></label>
    <div class="input-group"><i class="fa-solid fa-id-card"></i><input type="text" id="p_name" placeholder="Full Name"></div>

    <div class="upload-box" onclick="document.getElementById('imgIn').click()">
        <img id="preview-img"><div id="upload-txt"><i class="fa-solid fa-cloud-arrow-up" style="font-size:2rem; color:#ccc;"></i><p style="margin:5px 0 0 0; color:#888;">Upload Scan</p></div>
    </div>
    <input type="file" id="imgIn" hidden accept="image/*" onchange="previewImage()">

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>Age <span style="color:red">*</span></label><div class="input-group"><i class="fa-solid fa-calendar"></i><input type="number" id="age" placeholder="Age"></div></div>
        <div><label>Gender <span style="color:red">*</span></label><div class="input-group"><i class="fa-solid fa-venus-mars"></i><select id="gender"><option value="1">Male</option><option value="0">Female</option></select></div></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:10px;">
        <div><label>Ht (cm) <span style="color:red">*</span></label><input type="number" id="height"></div>
        <div><label>Wt (kg) <span style="color:red">*</span></label><input type="number" id="weight"></div>
        <div><label>Bld Grp <span style="color:red">*</span></label><select id="blood"><option value="A+">A+</option><option value="B+">B+</option><option value="O+">O+</option><option value="AB+">AB+</option></select></div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <div><label>Temp <span style="color:red">*</span></label><div class="input-group"><i class="fa-solid fa-temperature-half"></i><input type="number" id="temp" placeholder="37.5"></div></div>
        <div><label>BP <span style="color:red">*</span></label><div class="input-group"><i class="fa-solid fa-activity"></i><input type="text" id="bp" placeholder="120/80"></div></div>
    </div>
    
    <label>Sugar (mg/dL)</label>
    <div class="input-group"><i class="fa-solid fa-droplet"></i><input type="number" id="sugar" placeholder="90"></div>

    <label style="margin-top:10px;">Medical History</label>
    <textarea id="history" placeholder="Diabetes, Surgery..."></textarea>

    <button class="btn" onclick="runAnalysis()" id="analyzeBtn"><i class="fa-solid fa-microscope"></i> Run Analysis</button>

    <div id="results-card">
        <h4 style="margin:0 0 10px 0; color:var(--primary);">AI Findings</h4>
        <div id="bars"></div>
    </div>
</div>

<div class="main">
    <div class="chat-header">
        <div id="header-title">
            <h2 style="margin:0;">MediCare AI</h2>
            <small>Patient Mode (Guest)</small>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button class="btn btn-outline" id="loginBtn" onclick="document.getElementById('loginModal').style.display='flex'">Doctor Login</button>
            <button class="btn btn-outline" id="reportBtn" style="display:none;" onclick="generateReport()"><i class="fa-solid fa-file-pdf"></i> Report</button>
            <button class="btn btn-outline" id="saveBtn" style="display:none;" onclick="saveRecord()"><i class="fa-solid fa-save"></i> Save</button>
        </div>
    </div>

    <div id="chat-box"><div class="message ai-msg">Hello. I am the AI Assistant. Please upload data to begin.</div></div>
    
    <div class="chat-input">
        <input type="text" id="userMsg" placeholder="Ask questions..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="btn" style="width:50px;" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<div class="overlay" id="reportModal" onclick="if(event.target.className==='overlay') this.style.display='none'">
    <div class="report-paper paper" style="text-align: left;">
        <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:15px; margin-bottom:20px;">
            <h1 style="margin:0;">MEDICAL CASE REPORT</h1>
            <p style="color:#666; margin:5px 0 0 0;">Generated by MediCare AI Division</p>
        </div>
        
        <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
            <p><strong>Date:</strong> <span id="rep-date"></span></p>
            <p><strong>Scan:</strong> <span id="rep-type" style="text-transform:uppercase; font-weight:bold;"></span></p>
        </div>
        
        <div style="background:#f9f9f9; padding:15px; border-radius:5px; margin:20px 0;">
            <h4 style="margin-top:0;">PATIENT DEMOGRAPHICS</h4>
            <p style="margin:5px 0;"><strong>Name:</strong> <span id="rep-name"></span></p>
            <p style="margin:5px 0;"><strong>Age/Sex:</strong> <span id="rep-age"></span> / <span id="rep-sex"></span></p>
            <p style="margin:5px 0;"><strong>Physical:</strong> <span id="rep-hw"></span> | <strong>Blood:</strong> <span id="rep-blood"></span></p>
            <p style="margin:5px 0;"><strong>Vitals:</strong> Temp <span id="rep-temp"></span>°C | BP <span id="rep-bp"></span></p>
        </div>

        <h4 style="margin-bottom:10px;">AI RADIOLOGY FINDINGS:</h4>
        <p id="rep-findings" style="font-size:0.95rem; line-height:1.6; background:#f9f9f9; padding:10px; border-left:3px solid var(--primary); min-height:50px;"></p>

        <div class="disclaimer">
            <strong>DISCLAIMER:</strong> I am an AI, not a doctor. This analysis is for informational purposes only and does not constitute a medical diagnosis. If you have concerns about a medical scan, please consult a qualified radiologist or medical professional.
        </div>

        <button class="btn" onclick="window.print()" style="margin-top:20px;"><i class="fa-solid fa-print"></i> Print Report</button>
    </div>
</div>

<script>
    let currentSummary = "";
    let medicalContext = "";
    let isDoctor = "{{ 'true' if is_doctor else 'false' }}" === "true";

    window.onload = function() { updateUI(); };

    function updateUI() {
        if (isDoctor) {
            document.getElementById('header-title').innerHTML = "<h2 style='margin:0; color:#008080;'>Dr. AI Surgical Console</h2><small style='color:green;'>● Doctor Logged In</small>";
            document.getElementById('reportBtn').style.display = 'block';
            document.getElementById('saveBtn').style.display = 'block';
            document.getElementById('loginBtn').innerText = "Logout";
            document.getElementById('loginBtn').onclick = logout;
        } else {
            document.getElementById('header-title').innerHTML = "<h2 style='margin:0;'>MediCare AI</h2><small>Patient Mode</small>";
            document.getElementById('reportBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('loginBtn').innerText = "Doctor Login";
            document.getElementById('loginBtn').onclick = function(){document.getElementById('loginModal').style.display='flex'};
        }
    }

    async function performLogin() {
        const u = document.getElementById('l_user').value;
        const p = document.getElementById('l_pass').value;
        const formData = new URLSearchParams();
        formData.append('username', u);
        formData.append('password', p);
        
        try {
            const res = await fetch('/login', { method: 'POST', body: formData });
            const data = await res.json();
            if(data.status === 'success') {
                isDoctor = true;
                document.getElementById('loginModal').style.display = 'none';
                updateUI();
                alert("Login Successful!");
            } else { alert("Invalid Credentials."); }
        } catch(e) { alert("Server Error."); }
    }

    async function logout() {
        await fetch('/logout');
        isDoctor = false;
        location.reload();
    }

    async function saveRecord() {
        if(!currentSummary) return alert("Run analysis first.");
        const res = await fetch('/save_patient', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: document.getElementById('p_name').value,
                age: document.getElementById('age').value,
                diagnosis: currentSummary
            })
        });
        alert("Record Saved.");
    }

    function previewImage() {
        const file = document.getElementById('imgIn').files[0];
        if(file) {
            const r = new FileReader();
            r.onload = function(e) { document.getElementById('preview-img').src = e.target.result; document.getElementById('preview-img').style.display='block'; }
            r.readAsDataURL(file);
        }
    }

    async function runAnalysis() {
        // --- SAFE VALIDATION (Fixes 'null' error) ---
        const fields = ['imgIn', 'p_name', 'age', 'gender', 'temp', 'bp', 'height', 'weight', 'blood'];
        for(let id of fields) {
            let el = document.getElementById(id);
            if(!el || !el.value) {
                alert(`Please fill the field: ${id}`);
                return;
            }
        }

        const btn = document.getElementById('analyzeBtn');
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Analyzing...';
        btn.disabled = true;
        
        const fd = new FormData();
        fd.append('image', document.getElementById('imgIn').files[0]);
        fd.append('scan_type', document.getElementById('scan_type').value);
        fd.append('age', document.getElementById('age').value);
        fd.append('gender', document.getElementById('gender').value);
        fd.append('hr', '72'); // Default
        fd.append('temp', document.getElementById('temp').value);

        try {
            const res = await fetch('/predict', { method: 'POST', body: fd });
            const data = await res.json();
            
            if(data.error) throw new Error(data.error);

            btn.innerHTML = '<i class="fa-solid fa-check"></i> Complete';
            btn.disabled = false;
            currentSummary = data.summary;
            
            // Show Results
            document.getElementById('results-card').style.display='block';
            document.getElementById('bars').innerHTML = "";
            
            if(data.results) {
                let sorted = Object.entries(data.results).sort((a,b) => b[1] - a[1]);
                sorted.forEach(([d, s]) => {
                    if(s > 0.05) {
                        let color = s > 0.5 ? 'high' : '';
                        document.getElementById('bars').innerHTML += `
                        <div style="display:flex; justify-content:space-between; font-size:0.9rem; margin-top:5px;"><span>${d}</span><span>${(s*100).toFixed(0)}%</span></div>
                        <div class="progress-track"><div class="progress-fill ${color}" style="width:${s*100}%"></div></div>`;
                    }
                });
            }

            medicalContext = `
            PATIENT: ${document.getElementById('p_name').value} (Age: ${document.getElementById('age').value})
            VITALS: Temp ${document.getElementById('temp').value}C, BP ${document.getElementById('bp').value}, Sugar ${document.getElementById('sugar').value}
            HISTORY: ${document.getElementById('history').value}
            SCAN DIAGNOSIS: ${data.summary}`;
            
            addMsg(`<strong>Scan Complete. Findings:</strong><br>${data.summary}`, 'ai-msg');
            askAI("Generate a clinical assessment based on my scan results and my vitals (BP/Sugar).");

        } catch(e) { 
            btn.innerHTML = 'Error'; 
            btn.disabled = false; 
            alert("Analysis Failed: " + e.message); 
        }
    }

    async function sendMessage() {
        const txt = document.getElementById('userMsg').value;
        if(!txt) return;
        addMsg(txt, 'user-msg');
        document.getElementById('userMsg').value = "";
        askAI(txt);
    }

    async function askAI(msg) {
        const loadingId = "load_" + Date.now();
        const loadDiv = document.createElement('div');
        loadDiv.className = 'message ai-msg';
        loadDiv.id = loadingId;
        loadDiv.innerHTML = '...';
        document.getElementById('chat-box').appendChild(loadDiv);

        try {
            const res = await fetch('/chat', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg, context: medicalContext })
            });
            const data = await res.json();
            document.getElementById(loadingId).remove();
            addMsg(data.reply, 'ai-msg');
        } catch(e) { document.getElementById(loadingId).innerText = "Error."; }
    }

    function addMsg(text, cls) {
        const div = document.createElement('div');
        div.className = `message ${cls}`;
        div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
        document.getElementById('chat-box').appendChild(div);
        document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
    }

    function generateReport() {
        document.getElementById('rep-date').innerText = new Date().toLocaleDateString();
        document.getElementById('rep-type').innerText = document.getElementById('scan_type').value;
        document.getElementById('rep-name').innerText = document.getElementById('p_name').value;
        document.getElementById('rep-age').innerText = document.getElementById('age').value;
        document.getElementById('rep-sex').innerText = document.getElementById('gender').value == 1 ? "Male" : "Female";
        document.getElementById('rep-blood').innerText = document.getElementById('blood').value;
        document.getElementById('rep-hw').innerText = `${document.getElementById('height').value}cm / ${document.getElementById('weight').value}kg`;
        document.getElementById('rep-temp').innerText = document.getElementById('temp').value;
        document.getElementById('rep-bp').innerText = document.getElementById('bp').value;
        document.getElementById('rep-history').innerText = document.getElementById('history').value || "No history provided.";
        document.getElementById('rep-findings').innerText = currentSummary;
        document.getElementById('reportModal').style.display = 'flex';
    }
</script>

</body>
</html>